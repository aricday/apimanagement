---
## trusted_certificate.yml
# trusted cert is generated by the node/cluster name so this should be created
# when the cluster name is set in the headless config option
- name: store the Gateway SSL certificate as a variable which will become a SSL Trusted Certificate
  shell: /usr/bin/openssl s_client -showcerts -connect localhost:{{ cluster.ssl_port }} < /dev/null 2> /dev/null | /usr/bin/openssl x509 -outform PEM | /bin/sed -e '/-\(BEGIN\|END\) CERTIFICATE-/ { d; }'
  register: certificate

- name: copy the {{ trusted_certificate.file.src }} to the appropriate destination
  template: src={{ trusted_certificate.file.src }} dest={{ trusted_certificate.file.dest }} mode=644

- name: create the SSL Trusted Certificate via RESTMAN
  command: "/usr/bin/curl -u {{ admin.user }}:{{ admin.pass }} -X POST -k -H 'Content-Type: application/xml' -d @{{ trusted_certificate.file.dest }} -s -D - https://localhost:{{ trusted_certificate.ssl_port }}{{ trusted_certificate.api_url }} -o {{ trusted_certificate.curl_log }}"

